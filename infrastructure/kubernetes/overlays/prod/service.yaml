# Human Tasks:
# 1. Verify that the backend-config exists in GCP for the service
# 2. Ensure firewall rules allow traffic on port 80
# 3. Confirm health check endpoint is implemented in the application
# 4. Validate that network policies allow required pod-to-pod communication

# Kubernetes v1.24+ Service configuration for production environment
# Addresses requirements:
# - Load Balancing (7. System Architecture/7.1 High-Level Architecture)
# - High Availability (11.1 Deployment Environment/11.1.1 Environment Architecture)
# - Network Security (10.2 Data Security/10.2.1 Data Classification)

apiVersion: v1
kind: Service
metadata:
  name: code-generation-app
  namespace: code-generation-app
  labels:
    app: code-generation-app
    environment: production
    managed-by: kustomize
  annotations:
    # GCP-specific annotations for load balancer configuration
    cloud.google.com/neg: '{"ingress": true}'
    cloud.google.com/backend-config: '{"default": "code-generation-app-backend-config"}'
    
    # Kubernetes metadata annotations
    app.kubernetes.io/part-of: code-generation-app
    app.kubernetes.io/managed-by: kustomize
    
    # Monitoring annotations
    prometheus.io/scrape: "true"
    prometheus.io/port: "80"
    prometheus.io/path: "/metrics"
    
    # Health check annotations
    health.check.path: "/health"
    health.check.port: "80"

spec:
  # Service type configuration for internal access
  type: NodePort
  
  # Port configuration matching deployment container ports
  ports:
    - name: http
      port: 80
      targetPort: 8000
      protocol: TCP
  
  # Selector matching deployment pod labels
  selector:
    app: code-generation-app
    environment: production
  
  # Session affinity configuration
  sessionAffinity: None
  
  # External traffic policy for better load balancing
  externalTrafficPolicy: Local
  
  # Health check configuration
  healthCheckNodePort: 32000
  
  # Publishing not ready addresses configuration
  publishNotReadyAddresses: false
  
  # IP families configuration
  ipFamilyPolicy: SingleStack
  ipFamilies:
    - IPv4